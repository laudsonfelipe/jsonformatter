<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Formatador JSON</title>
    <style>
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #f0f2f5 0%, #e4e7eb 100%);
        color: #1a202c;
        margin: 0;
        padding: 20px 0; /* Removido padding lateral */
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        box-sizing: border-box;
      }
      header {
        text-align: center;
        margin-bottom: 20px;
      }
      h1 {
        font-size: 1.8em;
        font-weight: 700;
        color: #2b6cb0;
        letter-spacing: -0.025em;
      }
      .container {
        display: flex;
        flex: 1;
        gap: 20px;
        width: 100%; /* Ocupa toda a largura */
        margin: 0;
        box-sizing: border-box;
      }
      .editor,
      .viewer {
        flex: 1; /* Cada card ocupa metade da largura */
        display: flex;
        flex-direction: column;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        padding: 15px;
        width: 100%;
        box-sizing: border-box;
      }
      textarea {
        flex: 1;
        padding: 12px;
        font-family: "Fira Code", monospace;
        font-size: 14px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        resize: none;
        background: #f7fafc;
        transition: border-color 0.2s;
        width: 100%;
        box-sizing: border-box;
      }
      textarea:focus {
        outline: none;
        border-color: #2b6cb0;
      }
      #output {
        flex: 1;
        padding: 12px 12px 12px 24px;
        font-family: "Fira Code", monospace;
        font-size: 14px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        background: #f7fafc;
        overflow: auto;
        white-space: pre;
        position: relative;
        word-break: break-all; /* Quebra palavras longas */
        overflow-wrap: break-word; /* Compatibilidade com navegadores */
        width: 100%;
        box-sizing: border-box;
      }
      .tree-view {
        flex: 1;
        overflow: auto;
        padding: 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        background: #f7fafc;
        width: 100%;
        box-sizing: border-box;
      }
      .controls {
        display: flex;
        justify-content: flex-start;
        gap: 10px;
        margin-bottom: 12px;
      }
      button {
        padding: 8px 16px;
        background: #2b6cb0;
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.2s, transform 0.1s;
      }
      button:hover {
        background: #2c5282;
        transform: translateY(-1px);
      }
      button:active {
        transform: translateY(0);
      }
      select {
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #e2e8f0;
        background: #fff;
        cursor: pointer;
      }
      #error {
        color: #e53e3e;
        font-size: 14px;
        margin-top: 10px;
        font-weight: 500;
      }
      ul {
        list-style: none;
        padding-left: 20px;
        margin: 0;
      }
      li {
        margin: 4px 0;
      }
      .collapsible {
        cursor: pointer;
        user-select: none;
        display: inline-flex;
        align-items: center;
      }
      .collapsible::before {
        content: "▶";
        display: inline-block;
        margin-right: 6px;
        font-size: 10px;
        transition: transform 0.2s;
      }
      .collapsible.open::before {
        transform: rotate(90deg);
      }
      .content {
        display: none;
      }
      .open > .content {
        display: block;
      }
      .image-preview {
        position: relative;
        display: inline-block;
      }
      .image-preview:hover .preview {
        display: block;
      }
      .preview {
        display: none;
        position: absolute;
        z-index: 10;
        background: #fff;
        border: 1px solid #e2e8f0;
        padding: 5px;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .preview img {
        max-width: 200px;
        max-height: 200px;
        border-radius: 4px;
      }
      .string {
        color: #22863a;
      }
      .number {
        color: #d73a49;
      }
      .boolean {
        color: #032f62;
      }
      .null {
        color: #6f42c1;
      }
      .key {
        color: #005cc5;
      }
      .code-collapsible {
        position: relative;
        cursor: pointer;
        user-select: none;
        display: inline-block;
      }
      .code-collapsible::before {
        content: "▶";
        position: absolute;
        left: -16px;
        font-size: 10px;
        color: #2b6cb0;
        transition: transform 0.2s;
      }
      .code-collapsible.open::before {
        transform: rotate(90deg);
      }
      .code-content {
        display: none;
      }
      .code-collapsible.open + .code-content {
        display: block;
      }
      @media (max-width: 768px) {
        .container {
          flex-direction: column;
          gap: 10px;
        }
        .editor,
        .viewer {
          min-height: 300px;
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Formatador e Validador JSON</h1>
    </header>
    <div class="container">
      <div class="editor">
        <div class="controls">
          <button onclick="formatJSON()">Formatar e Validar</button>
          <input
            type="file"
            id="upload"
            style="display: none"
            onchange="uploadFile()"
          />
          <button onclick="document.getElementById('upload').click()">
            Carregar JSON
          </button>
          <button onclick="downloadJSON()">Baixar</button>
          <select id="indent">
            <option value="2">2 espaços</option>
            <option value="3">3 espaços</option>
            <option value="4" selected>4 espaços</option>
          </select>
        </div>
        <textarea id="input" placeholder="Cole seu JSON aqui..."></textarea>
        <div id="error"></div>
      </div>
      <div class="viewer">
        <div class="controls">
          <button onclick="toggleView('code')">Visão de Código</button>
          <button onclick="toggleView('tree')">Visão em Árvore</button>
        </div>
        <div id="output" style="display: block"></div>
        <div class="tree-view" id="tree" style="display: none"></div>
      </div>
    </div>

    <script>
      const input = document.getElementById("input");
      const output = document.getElementById("output");
      const tree = document.getElementById("tree");
      const error = document.getElementById("error");
      const indentSelect = document.getElementById("indent");
      let currentView = "code";

      // Carregar do armazenamento local
      window.onload = () => {
        const saved = localStorage.getItem("jsonData");
        if (saved) {
          input.value = saved;
          formatJSON();
        }
      };

      function formatJSON() {
        let text = input.value.trim();
        error.innerHTML = "";
        try {
          // Remover aspas externas se existirem
          if (text.startsWith('"') && text.endsWith('"')) {
            text = text.slice(1, -1);
          }
          let json = text;
          // Tentar parsear múltiplos níveis de strings JSON
          while (typeof json === "string") {
            json = JSON.parse(json);
          }
          const indent = parseInt(indentSelect.value);
          buildCodeView(json, output, indent);
          buildTree(json, tree);
          localStorage.setItem("jsonData", input.value);
        } catch (e) {
          let errorMessage = e.message;
          // Traduzir mensagens de erro para o português
          if (errorMessage.includes("Unexpected non-whitespace character after JSON")) {
            errorMessage = "Caractere inesperado após o JSON na posição " + (e.message.match(/position \d+/)?.[0]?.replace("position ", "") || "");
          } else if (errorMessage.includes("Unexpected token")) {
            errorMessage = "Token inesperado: " + (e.message.match(/Unexpected token .+ in JSON at position \d+/)?.[0] || "");
          } else if (errorMessage.includes("Unexpected end of JSON input")) {
            errorMessage = "Fim inesperado da entrada JSON";
          } else {
            errorMessage = "Erro ao processar o JSON: " + errorMessage;
          }
          error.innerHTML = `Erro: ${errorMessage}`;
          output.innerHTML = "";
          tree.innerHTML = "";
        }
      }

      function uploadFile() {
        const file = document.getElementById("upload").files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            input.value = e.target.result;
            formatJSON();
          };
          reader.readAsText(file);
        }
      }

      function downloadJSON() {
        let text;
        try {
          let json = input.value.trim();
          if (json.startsWith('"') && json.endsWith('"')) {
            json = json.slice(1, -1);
          }
          while (typeof json === "string") {
            json = JSON.parse(json);
          }
          text = JSON.stringify(json, null, parseInt(indentSelect.value));
        } catch (e) {
          error.innerHTML = `Erro: Não é possível baixar um JSON inválido`;
          return;
        }
        if (!text) return;
        const blob = new Blob([text], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "formatted.json";
        a.click();
        URL.revokeObjectURL(url);
      }

      function toggleView(view) {
        currentView = view;
        if (view === "code") {
          output.style.display = "block";
          tree.style.display = "none";
        } else {
          output.style.display = "none";
          tree.style.display = "block";
        }
      }

      function buildCodeView(json, parent, indent = 4, level = 0) {
        parent.innerHTML = "";
        const isArray = Array.isArray(json);
        const wrapper = document.createElement("div");

        // Abrir chave/colchete
        const openLine = document.createElement("div");
        openLine.style.marginLeft = `${level * indent}px`;
        const openSpan = document.createElement("span");
        openSpan.textContent = isArray ? "[" : "{";
        openSpan.className = "code-collapsible open"; // já aberto
        openLine.appendChild(openSpan);
        wrapper.appendChild(openLine);

        // Conteúdo
        const content = document.createElement("div");
        content.className = "code-content";
        content.style.display = "block"; // já aberto

        const entries = isArray
          ? json.map((v, i) => [i, v])
          : Object.entries(json);

        entries.forEach(([key, value], index) => {
          const line = document.createElement("div");
          line.style.marginLeft = `${(level + 1) * indent}px`;

          if (!isArray) {
            const keySpan = document.createElement("span");
            keySpan.className = "key";
            keySpan.textContent = `"${key}": `;
            line.appendChild(keySpan);
          }

          if (value !== null && typeof value === "object") {
            buildCodeView(value, line, indent, level + 1);
          } else {
            const valSpan = document.createElement("span");
            valSpan.className = typeof value;
            valSpan.textContent = JSON.stringify(value);
            if (typeof value === "string" && isImageUrl(value)) {
              const previewDiv = document.createElement("div");
              previewDiv.className = "image-preview";
              previewDiv.appendChild(valSpan);
              const preview = document.createElement("div");
              preview.className = "preview";
              const img = document.createElement("img");
              img.src = value;
              preview.appendChild(img);
              previewDiv.appendChild(preview);
              line.appendChild(previewDiv);
            } else {
              line.appendChild(valSpan);
            }
          }

          if (index < entries.length - 1)
            line.appendChild(document.createTextNode(","));
          content.appendChild(line);
        });

        wrapper.appendChild(content);

        // Fechar chave/colchete
        const closeLine = document.createElement("div");
        closeLine.style.marginLeft = `${level * indent}px`;
        closeLine.textContent = isArray ? "]" : "}";
        wrapper.appendChild(closeLine);

        // Toggle
        openSpan.onclick = () => {
          content.style.display =
            content.style.display === "none" ? "block" : "none";
          openSpan.classList.toggle("open");
        };

        parent.appendChild(wrapper);
      }

      function buildTree(json, parent) {
        parent.innerHTML = "";
        const ul = document.createElement("ul");
        if (Array.isArray(json)) {
          json.forEach((item, index) => {
            appendItem(ul, index, item);
          });
        } else {
          for (const key in json) {
            appendItem(ul, key, json[key]);
          }
        }
        parent.appendChild(ul);
      }

      function appendItem(ul, key, value) {
        const li = document.createElement("li");
        const spanKey = document.createElement("span");
        spanKey.className = "key";
        spanKey.textContent =
          typeof key === "string" ? `"${key}": ` : `${key}: `;
        li.appendChild(spanKey);

        if (typeof value === "object" && value !== null) {
          const collapsible = document.createElement("span");
          collapsible.className = "collapsible";
          collapsible.textContent = Array.isArray(value) ? "[...]" : "{...}";
          li.appendChild(collapsible);

          const content = document.createElement("div");
          content.className = "content";
          buildTree(value, content);
          li.appendChild(content);

          collapsible.onclick = () => {
            collapsible.classList.toggle("open");
            content.style.display = collapsible.classList.contains("open")
              ? "block"
              : "none";
          };
        } else {
          const spanValue = document.createElement("span");
          spanValue.className = typeof value;
          let text = JSON.stringify(value);
          spanValue.textContent = text;

          if (typeof value === "string" && isImageUrl(value)) {
            const previewDiv = document.createElement("div");
            previewDiv.className = "image-preview";
            previewDiv.appendChild(spanValue);

            const preview = document.createElement("div");
            preview.className = "preview";
            const img = document.createElement("img");
            img.src = value;
            preview.appendChild(img);
            previewDiv.appendChild(preview);

            li.appendChild(previewDiv);
          } else {
            li.appendChild(spanValue);
          }
        }
        ul.appendChild(li);
      }

      function isImageUrl(url) {
        return /\.(jpg|jpeg|png|gif|bmp|svg)$/i.test(url);
      }
    </script>
  </body>
</html>